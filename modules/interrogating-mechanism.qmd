---
title: "Analyzing Data for Racial Equity"
subtitle: "Module 2: Interrogating Mechanism"
format:
  revealjs:
    smaller: true
    scrollable: true
    code-copy: true
editor: 
  markdown: 
    wrap: 72
---

```{r packages, echo = FALSE}
library(here)
library(ggplot2)
library(ggnewscale)
library(tidyverse)
library(tidycensus)
library(sf)
library(patchwork)
library(dots)
library(dplyr)

tidycensus::census_api_key("ce143e4c445f1ccaed3aa214715bebcb9a487cfa")
sf::sf_use_s2(FALSE)
```

```{r config, echo=FALSE}
library(knitr)

knitr::opts_chunk$set(message = FALSE,
                      tidy.opts = list(width.cutoff = 60),
                      tidy = TRUE,
                      cache = TRUE)

options(scipen = 999,
        digits = 2,
        tigris_use_cache = TRUE) # Cache Census geographies to avoid repeat downloads

knitr::knit_hooks$set(inline = function(x) {
  prettyNum(x, big.mark = ",")
})
```

## Module 1: Identifying Injustice Recap

::: incremental
- Racial equity is a **practice**, not a target
- Racial inequity is a **difference**, or disparity, in quality of service or access to resources
- Disparities can represent **injustice**
- Identifying the **mechanism** of injustice helps us:
  - Contemplate effective interventions
  - Identify other places affected by the same mechanism
:::  

::: footer
üîó [California State Water Resources Control
Board - Racial Equity](https://www.waterboards.ca.gov/racial_equity/)

üìñ [Equity Data Handbook - Planning - Describe the selected program,
policy, or process, and populations affected by
it](https://cawaterboarddatacenter.github.io/equity-data-handbook/plan-prep/plan.html)
:::

## Module 1: Identifying Injustice Recap

::: columns
::: {.column width="50%"}
As of 2024, California had 220 failing drinking water systems serving
nearly half a million people.

Lamont has received \$25 million in Water Board funding to help fix their failing
drinking water system, which included three wells exceeding the Maximum
Contaminant Level of arsenic and 1,2,3-tricholoropropane.
:::

::: {.column width="50%"}
![](assets/kern_county_ca.png)
:::
:::

::: footer
üîó [Water Board grants Lamont District $25.4 million to secure safe drinking water for 20,000 residents](https://www.waterboards.ca.gov/press_room/press_releases/2023/pr021323-lamont.pdf)
:::

## Module 1: Identifying Injustice Recap

We found that people living in the **city center** are more likely to use public water,
and that in Lamont, those people are more likely to be **Hispanic** in origin.

We also know from the linked press release that mitigation efforts in Lamont included the destruction of **three 45-year-old wells**
that exceeded the state Maximum Contaminant Levels (MCL) for **arsenic** and 
**1,2,3-trichloropropane**.

::: footer
üîó [California State Water Resources Control Board - 1,2,3,-Trichloropropane (1,2,3 - TCP) - Background](https://waterboards.ca.gov/drinking_water/certlic/drinkingwater/123TCP.html)
:::

## Root cause analysis

> "Technique that helps identify the fundamental reasons, or root causes, of a problem or unwanted outcome"

::: fragment
A few considerations:
:::

::: incremental
- Your team should include community partners
- Allocate enough time to be thoughtful and pursue leads
- Honor hard truths!
:::

::: footer
üìñ [Equity Data Handbook - Evaluation - Root Cause
Analysis](https://cawaterboarddatacenter.github.io/equity-data-handbook/eval.html#root-cause-analysis)
:::

## Root cause analysis

![Methods for interrogating the problem](assets/rca_template.png)

::: footer
üìñ [Equity Data Handbook - Evaluation - Root Cause
Analysis - Process](https://cawaterboarddatacenter.github.io/equity-data-handbook/eval.html#process)
:::

## What are the root causes of contamination and exposure to it?

Take **10 minutes** to discuss the root causes of contaminated water and exposure to it in Lamont. Some questions to consider include:

- How are people exposed to the contaminated water?
- How did contaminants get into the water?
- Why hadn't contaminants been removed from the water?

Use [this press release](https://www.waterboards.ca.gov/press_room/press_releases/2023/pr021323-lamont.pdf) for extra context, if needed.

**One person from each group will share a summary of their group's discussion when we reconvene.**

## How are people exposed to the contaminated water?

::: incremental
- Public water use, which as we learned, is a function of where you live
- Why do people live where they live?
  - Redlining
  - Tribal lands
  - Proximity to work
:::

::: notes
An important factor, but not one within the Water Boards remit
:::

## How did contaminants get into the water?

::: incremental
- Age of wells
- Concentration of agricultural activity
:::

::: notes
- Public water wells typically have a lifespan of 20 to 50 years
- Chemical reactions of common pesticides may produce of 1,2,3-trichloropropane
:::

## Why hadn't contaminants been removed from the water?

::: incremental
- Permitting
- Cooperation
- Limited resources
::: 

::: notes
Resources = SAFER lever!
:::
  
# Scaling intervention

## Where else is the mechanism at play?

SAFER has funded **15 water system consolidation projects in Kern County**, where Lamont is located. That's about **16 percent** of SAFER-funded consolidations statewide. 

**Is there a common factor affecting water systems in Kern County that might also affect water systems in other counties?** 

üõéÔ∏è Chime in or share your ideas in the chat.

::: notes
Any of the root causes we just discussed.
:::

## Where else is the mechanism at play?

Let's focus on one of the mechanisms we suspect led to contamination: **agricultural activity.** If we can identify other places where agricultural activity occurs, then we might find other places where the water is contaminated.

**What data might help us understand the relationship between agriculture and water system health?** 

üõé Chime in or share your ideas in the chat.

::: notes
- Land use
- Pesticide use
- Water system status (SAFER)
:::

# Notes on mapping

## Map projections

- Maps are flat, the earth is not
- Projection determines how your mapping software translates the earth's curvature into a flat map
- Different projections won't overlay cleanly
  - A lot of software, like R, will throw an error if you ask it to operate on map layers in different projections

![Examples of different map projections](assets/map_projections.jpg)
  
## Map projections

- Projections to know
  - [WGS84: ESPG:4326](https://epsg.io/4326) - Global lat/long
  - [California Albers Equal Area: ESPG:3310](https://epsg.io/3310) - Statewide analysis of California
  - California State Plane Coordinate System (SPCS) - Detailed analysis of California regions
    - [Zone I (North): EPSG:2225](https://epsg.io/2225)
    - [Zone II (North Central): EPSG:2226](https://epsg.io/2226)
    - [Zone III (Central): EPSG:2227](https://epsg.io/2227)
    - [Zone IV (South Central): EPSG:2228](https://epsg.io/2228)
    - [Zone V (South): EPSG:2229](https://epsg.io/2229)
    - [Zone VI (Los Angeles): EPSG:2230](https://epsg.io/2230)

## Accessibility

- **Accessibility is part of equity!**
- Color blindness
  - [ColorBrewer](https://colorbrewer2.org/)
  - In R (`ggplot`):
    - Discrete* scales: [Brewer color scales](https://ggplot2.tidyverse.org/reference/scale_brewer.html)
    - Discrete and continuous scales: [Viridis color scales](https://ggplot2.tidyverse.org/reference/scale_viridis.html)
- Vision impairment: Consider complementary text and/or data table

::: footer
üìñ [Equity Data Handbook - Data Visualization Design Considerations - Color](https://cawaterboarddatacenter.github.io/equity-data-handbook/assure-analyze/vis.html#color)
:::

::: notes
Discrete: Counting
Continuous: Measuring
:::

## Storytelling

| Map type | Pros ‚úÖ | Cons  üö´| 
| - | - | - |
| Points | Communicates precise location | Illegible above a certain number of points | 
| Dot density | Communicates approximate distribution | Imprecise, illegible below and above a certain number of points |
| Choropleth | Communicates approximate distribution, able to distill large values | Difficult to layer |

::: footer
üîó [Axis Maps - Cartography Guide](https://www.axismaps.com/guide)
:::

## Pesticide use

Let's use CalEnviroScreen data to examine patterns of pesticide use across the
state.

::: fragment
Why CES?
:::

::: incremental
- Pesticide use is a proven vector of contamination
- CES does a lot of pre-processing for us ‚ù§Ô∏è
  - Filters for most hazardous and/or volatile pesticide ingredients
  - Calculates percentiles for comparability
  - Includes population characteristics (and other indicators!) for more detailed analysis
:::

::: footer
üìñ [Tribal Water Data Map - Layer Guide - CalEnviroScreen - Agricultural Pesticides](https://cawaterboarddatacenter.github.io/tribal-water-data-map-manual/layer-guide.html#agricultural-pesticides)

üîó [CalEnviroScreen - Pesticide Use Methodology](https://oehha.ca.gov/sites/default/files/media/downloads/calenviroscreen/report/calenviroscreen40reportf2021.pdf#page=79)
:::

## Pesticide use

First, let's retrieve our data from CalEnviroscreen.

```{r ces_shp}
#| echo: true
#| code-line-numbers: "1-4|5-6"
#| results: false
unzip(paste(here(), "data/raw/calenviroscreen40shpf2021shp.zip", sep="/"), exdir = "data/raw/calenviroscreen40shpf2021shp")
ces_shp <- paste(here(), "data/raw/calenviroscreen40shpf2021shp/CES4 Final Shapefile.shp", sep="/")
ces <- read_sf(ces_shp) %>% st_transform(3310)
```

::: footer
üîó [CalEnviroScreen - Download Data](https://oehha.ca.gov/calenviroscreen/download-data)
:::

## Pesticide use

Now, let's map pesticide use by tract.

```{r ces_map_a}
#| echo: true
#| code-line-numbers: "4-6|8-10"
#| results: false
#| output-location: slide
plotTheme <- list(
  theme_void(), 
  theme(
    plot.title = element_text(size = 14, face = "bold"), legend.position = "top", legend.direction = "horizontal",     plot.margin = margin(0, 0, 0, 0),
    panel.spacing = unit(0, "lines")
  )
)

pesticide_use <- ggplot() + geom_sf(
  ces, color = "white", linewidth = 0.001, mapping = aes(fill = PesticideP)
) + scale_fill_distiller(
  palette = "Greens", direction = 1
) + labs(
  title = "Agricultural Pesticide Use by Census Tract", subtitle = "Darker shade = higher percentile = more intensive pesticide use"
) + plotTheme
  
pesticide_use
```

## Pesticide use

Let's try a version of the map that only shows counties at or above the 75th
percentile to really emphasize heavy users.

```{r ces_map_b}
#| echo: true
#| results: false
#| output-location: slide
top_pesticide_use <- ggplot() + 
  geom_sf(ces, color = "lightgray", mapping = aes()) + 
  geom_sf(
  ces %>% filter(PesticideP >= 75), color = "white", linewidth = 0.001, mapping = aes(fill = PesticideP)
) + scale_fill_distiller(
  palette = "Greens", direction = 1
) +
  labs(
    title = "Agricultural Pesticide Use by Census Tract - Top 25%", subtitle = "Darker shade = higher percentile = more intensive pesticide use"
  ) + plotTheme
  
top_pesticide_use
```

## Pesticide use

::: columns
::: {.column width="50%"}
```{r cma}
#| crop: true
#| fig.width: 8
#| fig.height: 10
#| out.width: "100%"
pesticide_use
```
:::

::: {.column width="50%"}
```{r cmb}
#| crop: true
#| fig.width: 8
#| fig.height: 10
#| out.width: "100%"
top_pesticide_use
```
:::
:::

## Failing water systems

Now, let's take a look at SAFER data.

```{r safer_csv}
#| echo: true
safer_ra <- read_csv(paste(here(), "data/raw/SAFER_RA.csv", sep="/"))
safer_ra_as_sf <- st_as_sf(
  safer_ra %>% filter(LATITUDE_MEASURE != 0, LONGITUDE_MEASURE != 0), 
  coords=c("LONGITUDE_MEASURE", "LATITUDE_MEASURE"), crs=4326
) %>% st_transform(3310)
```

::: footer
üîó [Drinking Water Risk Assessment - California State Water Resource Control Boards - Division of Drinking Water](https://data.ca.gov/dataset/safer-failing-and-at-risk-drinking-water-systems)
:::

## Failing water systems

Plot the location of failing water systems on a map.

```{r safer_point_map}
#| echo: true
#| code-line-numbers: "1-5|7-9"
#| results: false
#| output-location: slide
safer_point_map <- ggplot() + 
  geom_sf(ces, color = "lightgray", mapping = aes()) + 
  geom_sf(safer_ra_as_sf %>% filter(CURRENT_FAILING == 'Failing'), colour = "darkred", alpha = 0.5, mapping = aes()) + 
  labs(title = "Failing Water Systems", subtitle = "Status determined by 2024 SAFER Risk Analysis") + 
  plotTheme
  
safer_point_map
```

## More pesticide use = more failing water systems?

Let's overlay failing systems with pesticide use to see if we can identify a
relationship.

```{r ces_safer_map}
#| echo: true
#| results: false
#| output-location: slide
ggplot() +
  geom_sf(ces, color = "lightgray", mapping = aes()) +
    geom_sf(
  ces %>% filter(PesticideP >= 75), color = "white", linewidth = 0.001, mapping = aes(fill = PesticideP)
) + scale_fill_distiller(
  palette = "Blues", direction = 1
) +
    geom_sf(safer_ra_as_sf %>% filter(CURRENT_FAILING == 'Failing'), colour = "darkorange", alpha = 0.5, mapping = aes()) + 
    labs(title = "Pesticide Use and Failing Water Systems") +
    plotTheme 
```

## More pesticide use = more failing water systems?

We can see a relationship, but how strong is it? Let's do a quick statistical
analysis to see whether there's a significant relationship between pesticide
use and failing water systems.

First, we need to aggregate the SAFER data by tract.

```{r tract_summary}
#| echo: TRUE
systems_with_tracts <- st_join(safer_ra_as_sf, ces)
  
failing_systems_by_tract <- systems_with_tracts %>% 
  group_by(Tract) %>% 
  summarize(n_systems = n(), n_failing = sum(CURRENT_FAILING == 'Failing', na.rm = TRUE), pct_failing = n_failing / n_systems * 100)
  
tracts_with_failing_systems <- st_join(ces, failing_systems_by_tract)
```

## More pesticide use = more failing water systems?

Next, we'll perform the analysis. Curious how we got here? Check out the code
on GitHub!

```{r analysis_correlation}
clean_data <- tracts_with_failing_systems %>% 
  filter(!is.na(PesticideP) & !is.na(pct_failing))
  
correlation <- cor(clean_data$PesticideP, clean_data$pct_failing)
if (abs(correlation) >= 0.7) {
  strength <- "strong"
} else if (abs(correlation) >= 0.4) {
  strength <- "moderate"
} else if (abs(correlation) >= 0.2) {
  strength <- "weak"
} else {
  strength <- "very weak/negligible"
}
direction <- ifelse(correlation > 0, "positive", "negative")
```

```{r analysis_linear_regression}
model <- lm(pct_failing ~ PesticideP, data = clean_data)
r_squared <- summary(model)$r.squared
p_value <- summary(model)$coefficients[2, 4]

if (p_value < 0.001) {
  pSignificance <- "highly significant ***"
} else if (p_value < 0.01) {
  pSignificance <- "very significant **"
} else if (p_value < 0.05) {
  pSignificance <- "significant *"
} else {
  pSignificance <- "not statistically significant"
}
```

```{r analysis_scatter_plot}
scatter_plot <- ggplot(clean_data, aes(x = PesticideP, y = pct_failing)) +
  geom_point(alpha = 0.6, color = "steelblue") +
  geom_smooth(method = "lm", se = TRUE, color = "darkorange", linetype = "dashed") +
  labs(
    title = "Pesticide Use vs Failing Water Systems",
    subtitle = sprintf("r = %.3f, R¬≤ = %.3f", correlation, r_squared),
    x = "Pesticide Use Percentile",
    y = "Failing Water Systems Proportion"
  ) +
  theme_minimal() +
  theme(plot.title = element_text(size = 14, face = "bold"))
```

::: columns
::: {.column width="33%"}
- **Relationship strength:** `r strength` `r direction`
- **R-squared:** `r r_squared`
- **P-value:** `r p_value` (`r pSignificance`)
:::

::: {.column width="67%"}
```{r}
scatter_plot
```
:::
:::

::: footer
üîó [Link to code on GitHub](#)
:::
  
## What should we do?

- What do we have the authority to do? What cause/s can we address?
- What interventions are already in place?
- Determine relationship to existing interventions

üõéÔ∏è Chime in or share your ideas in the chat.

::: notes
Augment SAFER investments or fill the gaps?
:::

## Filling the gaps

Let's target areas that have pesticide use and failing water systems but have
not received SAFER funding.

First, we need to aggregate our funding to the tract level.

```{r safer_funding_by_tract}
#| echo: true
#| code-line-numbers: 1-2|3-5|6|7-10
safer_funding_by_tract <- systems_with_tracts %>% 
  group_by(Tract) %>% 
  replace_na(list(FUNDING_RECEIVED_SINCE_2017=0)) %>% 
  summarise(funding_received=sum(FUNDING_RECEIVED_SINCE_2017) / 1000000) %>% 
  st_join(failing_systems_by_tract) %>% 
  st_join(ces)
```

## Filling the gaps

Now, let's filter for tracts in the top half of pesticide use with failing water
systems that have received no SAFER funding.

```{r unfunded_tracts}
#| echo: true
unfunded_at_risk_tracts <- safer_funding_by_tract %>% 
  select(Tract, ApproxLoc, TotPop19, PesticideP, n_failing, pct_failing, funding_received) %>% 
  filter(pct_failing > 0, funding_received == 0, PesticideP >= 50) %>% 
  arrange(desc(TotPop19))
```

## Filling the gaps

`r kable(head(unfunded_at_risk_tracts, n = 5))`

::: notes
- Maybe you're not in SAFER... but you can use that to understand where support exists...
- Maybe you are in SAFER, evaluate use of resources
:::

## Filling the gaps

Finally, let's map those tracts

```{r, evaluate = FALSE}
#| echo: TRUE
ggplot() +
  geom_sf(ces, color = "lightgray", mapping = aes()) +
  geom_sf(ces %>% st_filter(unfunded_at_risk_tracts), mapping = aes(fill = PesticideP)) +
  scale_fill_distiller(
    palette = "Greens", direction = 1
  ) + plotTheme
```

## Putting it all together

Once you've identified your candidate water systems, repeat the original analysis with your reproducible code!

::: incremental
- May find a dozen places that ‚Äúlook‚Äù the same as Lamont
- Prioritize places where you see disparity
- Validate your hypothesis that the same mechanism is at work by engaging with
the community, peers, etc.
:::

## Where do we go from here?

Is our analysis complete? What are we missing? What assumptions are we making?
What would you do next?

üõéÔ∏è Chime in or share your ideas in the chat.

## Where do we go from here?

::: incremental
- There are lots of wrong ways, but also lots of right ways
- Prioritize community engagement and partnerships
  - Validate and/or sharpen findings from data analysis
  - Address mechanisms outside your remit
  - Get at the full root cause, not just the water-shaped parts of it
:::

## Additional resources

You are not alone!

- [GitHub](https://github.com/CAWaterBoardDataCenter/equity-data-handbook-training/)
- [Modules](https://cawaterboarddatacenter.github.io/equity-data-handbook-training/)
- [Handbook](https://cawaterboarddatacenter.github.io/equity-data-handbook/)
- [EJ Roundtable Equity Data Subcommittee SharePoint](https://cawaterboards.sharepoint.com/sites/WB-OPP-EJRoundtable/SitePages/Racial-Equity-Data-Subcommittee.aspx?promotedState=0)
  - Next meeting: July 30, 2025
  - To join the subcommittee: [Submit this form!](https://forms.office.com/g/MgvutcbpD7)
- [Feedback survey](https://forms.office.com/g/FKAdxAgXap)
  - Estimated time to complete: 5 min
